{"creationTimeStamp":"2023-04-27T02:13:03.072Z","modifiedTimeStamp":"2023-05-01T17:54:38.062Z","createdBy":"Sundaresh.Sankaran@sas.com","modifiedBy":"Dragos.Coles@sas.com","name":"Import - Extract Table from PDF.step","displayName":"Import - Extract Table from PDF.step","localDisplayName":"Import - Extract Table from PDF.step","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","uri":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","uri":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","uri":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","uri":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","uri":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","uri":"/dataFlows/steps/da1491a2-f392-4679-98b6-092741cbc089","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[],"outputPorts":[{"name":"outputtable1","displayName":"outputtable1","localDisplayName":"outputtable1","minEntries":1,"maxEntries":1,"defaultEntries":0,"type":"table","supportsView":false,"requiresStructure":false},{"name":"outputtable2","displayName":"outputtable2","localDisplayName":"outputtable2","minEntries":1,"maxEntries":1,"defaultEntries":0,"type":"table","supportsView":false,"requiresStructure":false}]},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"param\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Parameters\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"inputSpec\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Input file specifications\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"text1\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"Note that this custom step works only with PDFs stored on the SAS Server filesystem.  PDF files saved in SAS Content are not supported.\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"fileName\",\n\t\t\t\t\t\t\t\"type\": \"path\",\n\t\t\t\t\t\t\t\"label\": \"Select a PDF:\",\n\t\t\t\t\t\t\t\"pathtype\": \"file\",\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"pageNumber\",\n\t\t\t\t\t\t\t\"type\": \"numberfield\",\n\t\t\t\t\t\t\t\"label\": \"Page number:\",\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"max\": null,\n\t\t\t\t\t\t\t\"min\": null,\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"tableNumber\",\n\t\t\t\t\t\t\t\"type\": \"numberfield\",\n\t\t\t\t\t\t\t\"label\": \"Table number:\",\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"max\": null,\n\t\t\t\t\t\t\t\"min\": null,\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"outputtable1\",\n\t\t\t\t\t\"type\": \"outputtable\",\n\t\t\t\t\t\"label\": \"Output table:\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"outputtable2\",\n\t\t\t\t\t\"type\": \"outputtable\",\n\t\t\t\t\t\"label\": \"All identified tabular structures:\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"about\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"aboutText\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"Import - Extract Table from PDF\\n\\nThis custom step enables you to extract tabular data from within a PDF document and load the same to a SAS dataset.\\n\\nA Python package, tabula-py, is a pre-requisite for running this step. In addition, SAS Studio needs to be configured to run Python code. Note that tabula-py, as mentioned in its documentation, works on text PDFs only, and not on PDFs containing tables in scanned / image formats.\\n\\nThis custom step enables use-cases requiring import of structured data from text (unstructured) sources into SAS for downstream analysis. For example, PDFs relating to scientific research often contain a mix of text and tabular information, and such tabular information needs to retain its structure in order to be useful.\\n\\n\\nPre-requisities:\\n\\n1. Configure SAS Studio to run Python. This is usually carried out by a SAS administrator.  Documentation link #1 (below) provides some information to get started.\\n\\n2. Install the tabula-py Python package.  Visit https://pypi.org/project/tabula-py/ for details.  The tabula-py package uses the tabula-java library (https://github.com/tabulapdf/tabula-java) under the covers, which requires a Java runtime to be installed and available to the environment.  This may not be an issue as SAS compute servers have Java installed. Tabula-py also has a dependency on pandas, which is installed (along with other dependencies) when tabula-py is installed.\\n\\nHint : You may like to use the Python -  Virtual Environments folder within the SAS Studio Custom Steps GitHub repository to create a virtual environment with tabula-py installed. Refer https://github.com/sassoftware/sas-studio-custom-steps/blob/main/Python%20Virtual%20environments/README.md.\\n \\n\\nParameters:\\n\\nNote : In this version, we recommend that users specify a desired table and page number.  In case users do not know the specific page number / table number in advance, an initial run of this custom step will extract the first identified table, and also provide a list of all possible tabular structures that were gleaned from the PDF through a second output table.  Users may refer to the second output table and make a decision on which table number to specify.  The page number is useful if the user has it, but not strictly necessary.  Future versions shall look to incorporate more automation and convenience.  \\n\\nAlso note that quality of output is dictated completely by the capabilties of tabula-py, the Python package used within this custom step.  Tabula-py is not guaranteed to accurately identify all table structures from PDFs (which might have been generated from different sources in different ways).\\n\\nInput parameters:\\n\\n1. Input file (file selector required): select a PDF file which is location on the SAS server filesystem. PDFs located within SAS Content folders should not be chosen as this custom step does not support the same.\\n\\n2. Page number (numeric field, optional): select a page on which your desired table is located. Leaving this field blank will lead to the first possible table across all pages getting extracted.\\n\\n3. Table number (numeric field, optional): provide a number (starting from 1) indicating the table you want to extract.  For example, 1 extracts the first table on the specified page, 2 extracts the second and so on. Leaving this field blank sets the table number as 1.\\n\\nOutput table specifications:\\n\\n1. Output table (output port, required): connect an output SAS dataset  to contain the extracted table. \\n\\n2. All identified tabular structures (output port, connecting a table is optional) : connect an output SAS dataset to this port in order to capture a list of all possible table structures that tabula-py was able to capture from the PDF.  You can use this as reference in case you were unsure about the table number, and rerun the custom step after identifying an appropriate table number.\\n\\nImportant:  You might notice an error stating \\\"Got stderr: Picked up _JAVA_OPTIONS: -Djava.awt.headless=true\\\" in the log.  You can safely ignore the same, as this is due to a Java option which is not relevant to the environment under which this custom step is run.\\nImportant: Your mileage might vary with the tabula-py package, but weâ€™ve successfully tested with various PDFs.\\n\\nDocumentation:\\n\\n1. Configuring SAS Viya for Python Integration: https://communities.sas.com/t5/SAS-Communities-Library/Configuring-SAS-Viya-for-Python-Integration/ta-p/847459\\n\\n2. PyPi page for tabula-py: https://pypi.org/project/tabula-py/\\n\\n3. Tabula-py documentation: https://tabula-py.readthedocs.io/en/latest/\\n\\n4. Tabula-py GitHub project: https://github.com/chezou/tabula-py\\n\\nCreated / contact : \\n\\n1. Sundaresh Sankaran (sundaresh.sankaran@sas.com)\\n\\n2. Dragos Coles (dragos.coles@sas.com)\\n\\nVersion : 1.0.   (01MAY2023)\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"fileName\": \"\",\n\t\t\"pageNumber\": 1,\n\t\t\"tableNumber\": 1,\n\t\t\"outputtable1\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"outputtable2\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t}\n\t}\n}","templates":{"SAS":"/* SAS templated code goes here */\n\n/*-----------------------------------------------------------------------------------------*\n   This block of code checks whether the user has selected a PDF from within the filesystem,\n   and not from SAS Content. The name of the file is obtained and stored inside a macro \n   variable.\n*------------------------------------------------------------------------------------------*/\n\n%let storageType=%upcase(%scan(\"&fileName.\",1,\":\"));\n\n%if \"&storageType.\"=\"SASSERVER\" %then %do;\n   data _null_;\n      call symput(\"fileNamePDF\",scan(\"&fileName.\",2,\":\",\"MO\"));\n   run;\n%end;\n%else %do;\n   %put ERROR:Select a PDF file from the filesystem.;\n   data _null_;\n      abort exit 4321;\n   run;\n%end;\n\n\n/*-----------------------------------------------------------------------------------------*\n   The following section contains Python code run within a proc python SAS procedure. For\n   ease of readability, comments are not provided within the proc python submit- endsubmit \n   block.  \n   \n   In this section, values are extracted from the UI and used to call the read_pdf function \n   of tabula_py.  Arguments provided to the function include the file name, the page number,\n   and the table number (counter).\n\n   Upon extraction, the result (which is a pandas dataframe) is written to a specified SAS \n   output dataset using the inbuilt SAS method.\n\n*------------------------------------------------------------------------------------------*/\n\nproc python;\nsubmit;\n\nfileNamePDF=SAS.symget(\"fileNamePDF\")\npageNumber=SAS.symget(\"pageNumber\")\ntableNumber=SAS.symget(\"tableNumber\")\noutputtable1=SAS.symget(\"outputtable1\")\noutputtable2=SAS.symget(\"outputtable2\")\n\nif not(tableNumber):\n   SAS.submit(\"%put NOTE: No Table number specified.  The first identified table will be extracted.;\")\n   tableNumber=1\n\nSAS.submit(\"%put NOTE: Table number : {};\".format(tableNumber))\n\nimport tabula\n\nif pageNumber:\n   SAS.submit(\"%put NOTE: Page number : {};\".format(pageNumber))\n   table = tabula.read_pdf(fileNamePDF,pages=int(pageNumber))\n   SAS.submit(\"%put NOTE: {} table(s) extracted;\".format(len(table)))\n   new_df=table[int(tableNumber)-1]\nelse:\n   SAS.submit(\"%put NOTE: All tables to be extracted;\")\n   table = tabula.read_pdf(fileNamePDF,pages=\"all\")\n   SAS.submit(\"%put NOTE: {} table(s) extracted;\".format(len(table)))\n   new_df=table[int(tableNumber)-1]\n\n\nif outputtable1:\n   SAS.submit(\"%put NOTE: Output table : {};\".format(outputtable1))\n   ndf=SAS.df2sd(new_df,dataset=outputtable1)\n   SAS.submit(\"%put NOTE: PDF table {} from page {} has been extracted and saved in {};\".format(tableNumber,pageNumber,outputtable1))\n\ntable_dict={\"table_number\":[],\"column_list\":[]}\ntnum=0\n\nfor eachDf in table:\n   tnum=tnum+1\n   table_dict[\"table_number\"].append(tnum)\n   table_dict[\"column_list\"].append(\"|\".join([col for col in eachDf]))\n\nif outputtable2:\n   SAS.submit(\"%put NOTE: Table containing column information : {};\".format(outputtable2))\n   import pandas\n   allTableCols=SAS.df2sd(pandas.DataFrame(table_dict),dataset=outputtable2)\n   \n\nendsubmit;\nquit;\n\n"}}