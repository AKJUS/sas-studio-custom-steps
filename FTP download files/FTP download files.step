{"creationTimeStamp":"2024-06-14T18:32:39.700Z","modifiedTimeStamp":"2024-08-12T11:40:09.721Z","createdBy":"Ethan.Kavanaugh@sas.com","modifiedBy":"Remco.Gooijer@sas.com","name":"FTP download files.step","displayName":"FTP download files.step","localDisplayName":"FTP download files.step","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","uri":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","uri":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","uri":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","uri":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea"},{"method":"POST","rel":"copy","href":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea/copy","uri":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea/copy","responseType":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","uri":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","uri":"/dataFlows/steps/f5356f94-4097-4932-8a93-270a395910ea","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[{"name":"_input","displayName":"_input","localDisplayName":"_input","minEntries":1,"maxEntries":1,"defaultEntries":0,"type":"table"}],"outputPorts":[{"name":"_output","displayName":"_output","localDisplayName":"_output","minEntries":1,"maxEntries":1,"defaultEntries":0,"type":"table","supportsView":false,"requiresStructure":false}]},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"page1\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Properties\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_input\",\n\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\"label\": \"Input table label 1\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_output\",\n\t\t\t\t\t\"type\": \"outputtable\",\n\t\t\t\t\t\"label\": \"Output table label 1\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sourceDir\",\n\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\"label\": \"Select the column with the source directory\",\n\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\"min\": 1,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"table\": \"_input\",\n\t\t\t\t\t\"include\": null\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sourceFile\",\n\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\"label\": \"Select the column with the source file\",\n\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\"min\": 1,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"table\": \"_input\",\n\t\t\t\t\t\"include\": null\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_ftpHost\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"FTP host\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_passive\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Passive mode\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_debug\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Debug information\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_userName\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"User name\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_password\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Password\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_targetdir\",\n\t\t\t\t\t\"type\": \"path\",\n\t\t\t\t\t\"label\": \"Target directory\",\n\t\t\t\t\t\"pathtype\": \"folder\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_removeSourceFile\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Delete source file after downloading?\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"Yes\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"No\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_removeTargetFile\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Remove target file before downloading?\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"Yes\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"No\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"page2\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"text2\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"FTP download files\\n=============\\n\\nThe \\\"FTP dowload files\\\" custom steps lets you download files from an FTP server, based on an input table containing the directory and filename.\\n\\nImportant: The transfer mode is always binary.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"section1\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Change log\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"text3\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* Version 1.1\\n- Published externally\\n\\n* Version 1.0\\n- Published internally\\n\\n\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"_input\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"_output\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"_sourceDir\": [],\n\t\t\"_sourceFile\": [],\n\t\t\"_ftpHost\": \"\",\n\t\t\"_passive\": true,\n\t\t\"_debug\": true,\n\t\t\"_userName\": \"\",\n\t\t\"_password\": \"\",\n\t\t\"_targetdir\": \"\",\n\t\t\"_removeSourceFile\": {\n\t\t\t\"value\": \"No\"\n\t\t},\n\t\t\"_removeTargetFile\": {\n\t\t\t\"value\": \"Yes\"\n\t\t}\n\t}\n}","templates":{"SAS":"/*\n\tRemove the directory type, sascontent or sasserver, from the _targetdir macro variable\n*/\ndata _null_;\n\tcall symputx(\"_targetdir\", scan(strip(\"&_targetdir\"), 2, ':') || '/');\nrun;\n\n/*\n\tInitialize the output table.\n*/\ndata &_output;\n\tattrib source_directory length=$256;\n\tattrib source_file length=$256;\n\tattrib target_directory length=$256;\n\tattrib rmv_src_after_dwnld length=$8;\n\tattrib rmv_trgt_bfr_dwnld length=$8;\n\tattrib processed_dttm length=8 format=datetime22.3;\n\tstop;\nrun;\n\n/*\n\tThe macro that does the actual download and, of requested, removes the source file from the FTP server.\n*/\n%macro download\n(\n\tsource_dir=,\n\tsource_file=\n);\n\n\t/*\n\t\tPut the input variables in the log for debugging.\n\t*/\n\t%put NOTE: &source_dir;\n\t%put NOTE: &source_file;\n\n\t/*\n\t\tRemove the target file if requested.\n\t*/\n\t%if &_removeTargetFile EQ Yes %then %do;\n\t\tdata _null_;\n\t\t\tlength ref $8;\n\t\t\t/*\n\t\t\t\tCreate a reference to the file about to be deleted.\n\t\t\t*/\n\t\t\trc = filename(ref, cats(\"&_targetdir\", \"&source_file\"));\n\t\t\tif rc = 0 and fexist(ref) then do;\n\t\t\t\trc = fdelete(ref);\n\t\t\t\tif rc = 0 then do;\n\t\t\t\t\tput \"NOTE: The file &_targetdir.&source_file has been removed.\";\n\t\t\t\tend;\n\t\t\t\telse do;\n\t\t\t\t\tput \"ERROR: The file &_targetdir.&source_file could not be removed.\";\n\t\t\t\t\tabort;\n\t\t\t\tend;\t\n\t\t\tend;\n\t\t\telse do;\n\t\t\t\tput \"NOTE: Not able to create a file reference or the file, &_targetdir.&source_file doesn't exist.\";\n\t\t\tend;\t\t\n\t\trun;\n\t%end;\n\n\t/*\n\t\tCreate a reference to the remote file.\n\t*/\n\tfilename ftp_file FTP\n\t\t\"&source_dir./&source_file\"\n\t\t%if &_passive %then %do;\n\t\t\tpassive\n\t\t%end;\n\t\tcd=\"&source_dir\"\n\t\tuser=\"&_userName\"\n\t\tpass=\"&_password\"\n\t\thost=\"&_ftpHost\"\n\t\t%if &_debug %then %do;\n\t\t\tdebug\n\t\t%end;\n\t\trecfm=s;\n\n\t/*\n\t\tDownload / copy the file to the target directory.\n\t*/\n\tfilename trgt \"&_targetdir.&source_file\" recfm=n;\n\tdata _null_;\n\t\tn=1;\n\t\tinfile ftp_file nbyte=n;\n\t\tinput;\n\t\tfile trgt;\n\t\tput _infile_ @@;\n\trun;\n\n\t/*\n\t\tValidate that the file has been copied and that the filename operation went as planned.\n\t*/\n\t%if &syserr eq 0 %then %do;\n\t\t%put NOTE: the file &_targetdir.&source_file has been transterred succesfully.;\n\t\t\n\t\t/*\n\t\t\tDelete the source file if requested.\n\t\t*/\n\t\t%if &_removeSourceFile EQ Yes %then %do;\n\t\t\t/*\n\t\t\t\tCreate a reference for the command that removes the source file.\n\t\t\t*/\n\t\t\tfilename ftp_file FTP ''\n\t\t\t\t%if &_passive %then %do;\n\t\t\t\t\tpassive\n\t\t\t\t%end;\n\t\t\t\tcd=\"&source_dir./\"\n\t\t\t\tuser=\"&_userName\"\n\t\t\t\tpass=\"&_password\"\n\t\t\t\thost=\"&_ftpHost\"\n\t\t\t\t%if &_debug %then %do;\n\t\t\t\t\tdebug\n\t\t\t\t%end;\n\t\t\t\trcmd=\"DELE &source_file\";\n\t\t\t\n\t\t\t/*\n\t\t\t\tExecute the FTP command, removing the source file.\n\t\t\t*/\n\t\t\tdata _null_;\n\t\t\t\tfile ftp_file;\n\t\t\trun;\n\n\t\t\t/*\n\t\t\t\tCheck for errors.\n\t\t\t*/\n\t\t\t%if &syserr eq 0 %then %do;\n\t\t\t\t%put NOTE: The file &source_dir./&source_file has been removed.;\n\t\t\t%end;\n\t\t\t%else %do;\n\t\t\t\t%put ERROR: The file &source_dir./&source_file failed to be removed.;\n\t\t\t%end;\n\t\t%end;\n\n\t\t/*\n\t\t\tAdd the file to the output table.\n\t\t*/\n\t\tdata status_record;\n\t\t\tattrib source_directory length=$256;\n\t\t\tattrib source_file length=$256;\n\t\t\tattrib target_directory length=$256;\n\t\t\tattrib rmv_src_after_dwnld length=$8;\n\t\t\tattrib rmv_trgt_bfr_dwnld length=$8;\n\t\t\tattrib processed_dttm length=8 format=datetime22.3;\n\t\t\t\n\t\t\tsource_directory = \"&source_dir\";\n\t\t\tsource_file = \"&source_file\";\n\t\t\ttarget_directory = \"&_targetdir\";\n\t\t\trmv_src_after_dwnld = \"&_removeSourceFile\";\n\t\t\trmv_trgt_bfr_dwnld = \"&_removeTargetFile\";\n\t\t\tprocessed_dttm = datetime();\n\t\t\toutput;\t\t\t\n\t\trun;\n\t\tproc append base=&_output data=work.status_record force; run;\n\t%end;\n\t%else %do;\n\t\t%PUT ERROR: The file &source_dir./&source_file failed to copy.;\n\t%end;\n%mend;\n\n/*\n\tFor each row in the input table, call the download macro.\n*/\ndata _null_;\n\tset\n\t\t&_input;\n\n\tcall execute\n\t\t(\n\t\t\tcats\n\t\t\t(\n\t\t\t\t'%download(source_dir= %STR(',\n\t\t\t\tstrip(&_sourceDir_1_name),\n\t\t\t\t'), source_file=%STR(',\n\t\t\t\tstrip(&_sourceFile_1_name),\n\t\t\t\t'))'\n\t\t\t)\n\t\t);\nrun;"}}