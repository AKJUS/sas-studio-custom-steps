{"type":"code","name":"OCR - Document Analysis - Produce Usage Report Output.step","displayName":"OCR - Document Analysis - Produce Usage Report Output.step","description":"","templates":{"SAS":"* _sda_ is short for SAS Document Analysis;\ndata _null_;\n    * Check that the user provided a valid ID for the launcher context;\n    if not prxMatch('/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i', \"&_sda_launcher_context_id.\") then do;\n        putLog 'ERROR: The provided launcher context ID is not valid.';\n        abort 42;\n    end;\nrun;\n\n* Clean up whitespace around delimited list entries;\n%let _sda_report_batch_tag_list = %sysfunc(compbl(%quote(&_sda_report_batch_tag_list.)));\n%let _sda_report_batch_tag_list = %sysfunc(tranwrd(%quote(&_sda_report_batch_tag_list.), %str(, ), %str(,)));\n%let _sda_report_batch_tag_list = %sysfunc(tranwrd(%quote(&_sda_report_batch_tag_list.), %str( ,), %str(,)));\n\n%let _sda_report_batch_sk_list = %sysfunc(compbl(%quote(&_sda_report_batch_sk_list.)));\n%let _sda_report_batch_sk_list = %sysfunc(tranwrd(%quote(&_sda_report_batch_sk_list.), %str(, ), %str(,)));\n%let _sda_report_batch_sk_list = %sysfunc(tranwrd(%quote(&_sda_report_batch_sk_list.), %str( ,), %str(,)));\n\n* Create a temporary file;\nfilename _sda_out temp; \n\n* Get the Viya Host URL;\n%let _sda_viyaHost=%sysfunc(getoption(SERVICESBASEURL));\n\n* Preprocess macrovars to convert binary to boolean;\n%if &_sda_report_include_header. %then %do; \n    %let _sda_report_include_header = True; \n%end;\n%else %do; \n    %let _sda_report_include_header = False; \n%end;\n\n* Compose http request body message;\n%let _SDA_HTTP_REQUEST_BODY=%str({ \"name\":\"sda-produce-usage-report\",\n          \"description\":\"Output SAS Document Analysis Usage Report\",\n           \"command\":\"python process/sda-ocr/scripts/%superq(_sda_command)\",\n           \"contextId\":\"%superq(_sda_launcher_context_id)\",\n           \"environment\":{\n                \"REPORT_OUTPUT_FORMAT\":\"%superq(_sda_report_output_format)\",\n                \"REPORT_INCLUDE_HEADER\":\"%superq(_sda_report_include_header)\",\n                \"REPORT_BATCH_SK_LIST\":\"%superq(_sda_report_batch_sk_list)\",\n                \"REPORT_BATCH_TAG_LIST\":\"%superq(_sda_report_batch_tag_list)\",\n                \"REPORT_MIN_DT\":\"%superq(_sda_report_min_dt)\",\n                \"REPORT_MAX_DT\":\"%superq(_sda_report_max_dt)\"\n            }, \n           \"kubernetes\": {\"jobNamePrefix\": \"sda-execute-report-\"} \n     });\n\n* Proc HTTP Request;\nproc http method='Post' \n    url=\"&_sda_viyaHost./launcher/processes\" \n    in=%tslit(&_SDA_HTTP_REQUEST_BODY)\n    oauth_bearer=sas_services\n    out=_sda_out; \n    headers 'Accept'='application/vnd.sas.launcher.process+json'; \n    headers 'Content-Type'='application/json';\nrun; quit;\n\n* HTTP Status Handling;\ndata _null_; \n    if &SYS_PROCHTTP_STATUS_CODE. lt 400 then do; \n        putLog 'NOTE: The request to launch the SDA process was successful.'; \n        putLog \"NOTE: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n        putLog \"NOTE: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n    end; \n    else do; \n        putLog 'ERROR: The request to launch the SDA process was most likely not successful.'; \n        putLog \"ERROR: The HTTP Status Code is &SYS_PROCHTTP_STATUS_CODE..\"; \n        putLog \"ERROR: That means: &SYS_PROCHTTP_STATUS_PHRASE..\"; \n    end; \nrun;\n\n* Print output message;\nlibname _sda_out json;\n\n%let _sda_output_directory = '';\n%let _sda_process = '';\n\ndata _null_;\n    set _sda_out.alldata;    \n    if upcase(P1)='ENVIRONMENT' then do;\n        if upcase(P2)='OUTPUT_DIRECTORY' then call symput('_sda_output_directory', cats(value));\n        if upcase(P2)='PROCESS' then call symput('_sda_process', cats(value));\n    end;\nrun;\n\ndata work._sda_message_output;\n    length message $300.;\n    if \"&_sda_output_directory.\" ne '' and \"&_sda_process.\" ne '' then do;\n        message = 'Logs have been routed to ' || \"&_sda_output_directory./&_sda_process./logs\";\n        output;\n        message = 'Output report has been routed to ' || \"&_sda_output_directory./&_sda_process./reports\";\n        output;\n    end;\n    else do;\n        message = 'Report and logs have been routed to the default location specified during installation';\n        output;\n    end;\nrun;\n\nproc print data=work._sda_message_output noObs;\n    var message;\nrun; quit;\n\n* Clean up;\n%symDel _sda_viyaHost _SDA_HTTP_REQUEST_BODY _sda_output_directory _sda_process;\nlibname _sda_out clear;\nfilename _sda_out clear;\nproc datasets library=work noList;\n    delete _sda_message_output;\nrun; quit;"},"properties":{},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"pageOptions\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Options\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_explainer_txt\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"SAS Studio Custom Step for executing the SAS Document Analysis report creation process. At a minimum, users must specify the report type to be output, the file format of the report, and the SAS Launcher Context ID to execute against.\\n\\nFor more details, please reference the link to the official documentation in the about page of this step.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_command\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Select report type:\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"create_batch_summary_report.py\",\n\t\t\t\t\t\t\t\"label\": \"Batch Summary\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"create_batch_transactions_report.py\",\n\t\t\t\t\t\t\t\"label\": \"Batch Transactions\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"create_file_summary_report.py\",\n\t\t\t\t\t\t\t\"label\": \"File Summary\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"create_file_transactions_report.py\",\n\t\t\t\t\t\t\t\"label\": \"File Transactions\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_report_output_format\",\n\t\t\t\t\t\"type\": \"dropdown\",\n\t\t\t\t\t\"label\": \"Select report output format:\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"xlsx\",\n\t\t\t\t\t\t\t\"label\": \"Excel (XLSX)\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"csv\",\n\t\t\t\t\t\t\t\"label\": \"CSV\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"html\",\n\t\t\t\t\t\t\t\"label\": \"HTML\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_launcher_context_id\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Enter the SAS launcher context ID:\",\n\t\t\t\t\t\"placeholder\": \"ex. b7be2e5f-a65a-4659-8e4e-84d833b2bcc5\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_sda_report_filters_section\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Report filters\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_include_header\",\n\t\t\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\t\t\"label\": \"Include report header? (Show filter criteria in output)\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_batch_sk_list\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Enter batch SK filter (provide as a comma-separated list):\",\n\t\t\t\t\t\t\t\"placeholder\": \"ex. 1, 2, 3\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"indent\": 0\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_batch_tag_list\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Enter batch tag filter (provide as comma-separated list):\",\n\t\t\t\t\t\t\t\"placeholder\": \"ex. Batch_123, Batch_ABC\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"indent\": 0\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_min_dt\",\n\t\t\t\t\t\t\t\"type\": \"datetime\",\n\t\t\t\t\t\t\t\"label\": \"Select the earliest execution date:\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"indent\": 0\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"_sda_report_max_dt\",\n\t\t\t\t\t\t\t\"type\": \"datetime\",\n\t\t\t\t\t\t\t\"label\": \"Select the latest execution date:\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"indent\": 0\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"pageAbout\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"textAbout\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"OCR - Document Analysis - Produce Usage Report Output step\\n==========\\n\\nThe \\\"OCR - Document Analysis - Produce Usage Report Output\\\" custom steps enables an easy integration with the SAS Document Analysis (SDA) model, to create output reports on executed runs.\\n\\nThe location of the generated output will be displayed for after running this step.\\n\\nThis step can be run after you executed a batch OCR process, for example by using the OCR - Document Analysis - Execute Batch OCR Process custom step.\\n\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionPrereqs\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Pre-requisites\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"indent\": 0,\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textPrereqs\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"A license for SAS Document Analysis (SDA) is required and you will need to know the ID of the launch context that was created during the deployment of SDA.\\n\\nPre-requisites:  Tested on Viya version Stable 2024.08\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionDocumentation\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Documentation\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textDocumentation\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* SAS Document Analysis documentation (https://go.documentation.sas.com/doc/en/aaimdacdc/default/aaimdawlcm/home.htm)\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionChangelog\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Changelog\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textChangelog\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* Version 1.1 (29OCT2024)\\n     - Implemented feedback\\n\\n* Version: 1.0 (07OCT2024)\\n      - Initial version\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"_sda_command\": null,\n\t\t\"_sda_report_output_format\": {\n\t\t\t\"value\": \"xlsx\",\n\t\t\t\"label\": \"Excel (XLSX)\"\n\t\t},\n\t\t\"_sda_launcher_context_id\": \"\",\n\t\t\"_sda_report_include_header\": false,\n\t\t\"_sda_report_batch_sk_list\": null,\n\t\t\"_sda_report_batch_tag_list\": \"\",\n\t\t\"_sda_report_min_dt\": null,\n\t\t\"_sda_report_max_dt\": null\n\t}\n}","flowMetadata":{"inputPorts":[],"outputPorts":[]}}