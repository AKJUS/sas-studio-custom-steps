{"type":"code","name":"GE - Generate Expectation Suite.step","displayName":"GE - Generate Expectation Suite.step","description":"","templates":{"SAS":"%macro set_up();\n\n%global dataPath folder disk;\n%let dataPath = %sysfunc(getoption(work));\n\n/* put input table in working directory as a csv */\nproc export data=&inTable\n   outfile=\"dataset.csv\"\n   dbms=csv\n   replace;\nrun;\n\n/* create table of columns to exclude */\nproc sql;\n   create table colNames\n      (column char(32));\n \n   %do i=1 %to &excludeCol_count; \n      insert into colNames\n         values(\"&&excludeCol_&i._name\");\n   %end;\nquit;\n\n%mend set_up;\n\n%set_up();\n\nproc python;\n   submit;\n\nimport great_expectations as gx\nimport pandas as pd\nfrom great_expectations.core.yaml_handler import YAMLHandler\nimport json\nfrom great_expectations.data_context.types.base import (\n        DataContextConfig,\n        InMemoryStoreBackendDefaults\n   )\nfrom great_expectations.data_context import EphemeralDataContext\nimport os\n\n# set up data context\nproject_config = DataContextConfig(\n   store_backend_defaults=InMemoryStoreBackendDefaults()\n)\ncontext = EphemeralDataContext(project_config=project_config)\n\n# get data -> saved in code of custom step\ndf = pd.read_csv(SAS.symget(\"dataPath\")+'/dataset.csv')\n\n# get path to working directory\npath_to_dir = SAS.symget(\"dataPath\")\nos.chdir(path_to_dir)\n\n# set up datasource\nyaml = YAMLHandler()\n\ndatasource_yaml = f\"\"\"\nname: my_datasource\nclass_name: Datasource\nmodule_name: great_expectations.datasource\nexecution_engine:\n  module_name: great_expectations.execution_engine\n  class_name: PandasExecutionEngine\ndata_connectors:\n    my_runtime_data_connector:\n        class_name: RuntimeDataConnector\n        batch_identifiers:\n            - id\n\"\"\"\n\n# add datasource to data context\ncontext.add_datasource(**yaml.load(datasource_yaml))\n\n# create runtime batch request (needed for pandas data source)\nfrom great_expectations.core.batch import RuntimeBatchRequest\nruntime_batch_request = RuntimeBatchRequest(\n   datasource_name=\"my_datasource\",\n   data_connector_name=\"my_runtime_data_connector\",\n   data_asset_name=\"insert_your_data_asset_name_here\",\n   runtime_parameters={\"batch_data\": df},\n   batch_identifiers={\n      \"id\": \"1\",\n   },\n)\n\n# check if batch request works\ncontext.get_batch_list(batch_request=runtime_batch_request)\n\n# get suite name from custom step\nsuite_name = SAS.symget(\"suiteName\")\n\n# create expectation suite\nexpectation_suite_name = suite_name\ncontext.add_or_update_expectation_suite(expectation_suite_name=expectation_suite_name)\nvalidator = context.get_validator(\n   batch_request=runtime_batch_request, \n   expectation_suite_name=expectation_suite_name\n)\n\n# set up list of columns to exclude\ncolumns = SAS.sd2df(\"work.ColNames\")\ncolumns = columns.to_numpy()\ncol = []\nfor i in range(columns.shape[0]):\n   col.append(columns[i][0])\nexclude_column_names = [\n   col\n][0] # without this [0] the whole thing breaks\n\n# run data assistant to create expectations\ndata_assistant_result = context.assistants.onboarding.run(\n   batch_request=runtime_batch_request,\n   exclude_column_names=exclude_column_names,\n)\n\n# get and save expectations\nexpectation_suite = data_assistant_result.get_expectation_suite(\n   expectation_suite_name=expectation_suite_name\n)\ncontext.add_or_update_expectation_suite(expectation_suite=expectation_suite)\n\n# save data context\nif os.path.exists(SAS.symget(\"dataPath\")+'/great_expectations/great_expectations.yml'):\n   print('Data Context has already been saved, please remove Data Context from work directory to save new expectations.')\nelse:\n   context = context.convert_to_file_context()\n\n# make output table\nformatted_data = {}\ndata = expectation_suite['expectations']\nfor entry in data:\n   expectation = entry.get('expectation_type')\n   if 'table' not in expectation:\n      kwargs = entry.get('kwargs')\n      column = kwargs.get('column')\n   else:\n      column = 'Table Expectation'\n   if expectation in formatted_data:\n      formatted_data[expectation].append(column)\n   else:\n      formatted_data[expectation] = []\n      formatted_data[expectation].append(column)\n\nfor entry in formatted_data:\n   formatted_data[entry] = ', '.join(map(str, formatted_data[entry]))\n\nout_df = pd.DataFrame(list(formatted_data.items()), columns=['expectation', 'columns'])\nSAS.df2sd(out_df, SAS.symget(\"out_expectations\"), overwrite=True)\n\n# get location in usable format, is input as drive:/path/to/output and need to be /path/to/output\nlocation = SAS.symget(\"location\")\ndisk = location.split(\":\")[0]\nfolder = location[location.find(\":\")+1:]\nSAS.symput(\"folder\",folder)\nSAS.symput(\"disk\",disk)\n   endsubmit;\nrun;\n\n%macro clean_up();\n/* move .json and .yml files to user specified location */\n\n%if \"&disk\" eq \"sascontent\" %then %do;\n   filename desti filesrvc folderPath=\"&folder\" Filename=\"great_expectations.yml\";\n%end;\n%else %do;\n   filename desti \"&folder./great_expectations.yml\";\n%end;\nfilename source \"%sysfunc(getoption(work))/great_expectations/great_expectations.yml\";\n%let rc = %sysfunc(fcopy(source, desti));\nfilename desti clear;\nfilename source clear;\n%if \"&disk\" eq \"sascontent\" %then %do;\n   filename desti filesrvc folderPath=\"&folder\" Filename=\"&suiteName..json\";\n%end;\n%else %do;\n   filename desti \"&folder./&suiteName..json\";\n%end;\nfilename source \"%sysfunc(getoption(work))/great_expectations/expectations/&suiteName..json\";\n%let rc = %sysfunc(fcopy(source, desti));\nfilename desti clear;\nfilename source clear;\n\n/* clean up work library */\nproc datasets library=work nolist;\n   delete colnames;\nquit;\n\ndata _null_;\n   fname=\"dataset\";\n   rc=filename(fname,\"dataset.csv\");\n   if rc = 0 and fexist(fname) then\n      rc=fdelete(fname);\n   rc=filename(fname);\nrun;\n%mend clean_up;\n\n%clean_up();\n\nproc python;\n   submit;\n# delete the generated great_expectations directory\nimport os, shutil\nfolder = SAS.symget(\"dataPath\")+'/great_expectations'\nfor filename in os.listdir(folder):\n   file_path = os.path.join(folder, filename)\n   try:\n      if os.path.isfile(file_path) or os.path.islink(file_path):\n         os.unlink(file_path)\n      elif os.path.isdir(file_path):\n         shutil.rmtree(file_path)\n   except Exception as e:\n      print('Failed to delete %s. Reason: %s' % (file_path, e))\nshutil.rmtree(folder)\n   endsubmit;\nrun;\n\n"},"properties":{},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"page1\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Generate Expectations\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"inTable\",\n\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\"label\": \"Select an input table:\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"location\",\n\t\t\t\t\t\"type\": \"path\",\n\t\t\t\t\t\"label\": \"Select a folder for output files:\",\n\t\t\t\t\t\"pathtype\": \"folder\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"out_expectations\",\n\t\t\t\t\t\"type\": \"outputtable\",\n\t\t\t\t\t\"label\": \"Generated expectations:\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"suiteName\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Input expectation suite name:\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"excludeCol\",\n\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\"label\": \"Pick columns to exclude:\",\n\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\"max\": null,\n\t\t\t\t\t\"min\": null,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"table\": \"inTable\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"page2\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"text1\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"GE - Generate Expectation Suite.step\\n=========\\n\\nThe \\\"GE - Generate Expectation Suite\\\" step generates data rules through the Great Expectations python library.\\n\\nRules can be customized by excluding columns from rule generation.\\n\\nThe output of this custom step will be a table summarizing the generated rules, a .json expectation suite file in the location indicated with the folder selector, and a great_expectations.yml in the same location. The output files can be used by the \\\"GE - Run Expectation Suite\\\" step to better understand how other data conforms to the rules set in this step.\\n\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"section2\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Parameters and outputs\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"text3\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"Components of this custom step are:\\n* Folder selector: Select the directory for output files (expectation suite .json and great_expectations.yml) to be placed within.\\n* Expectation suite name: Will be used to the name the expectation suite .json, so if the input is taxi_exp the output expectation suite will be saved as taxi_exp.json.\\n* Columns to exclude: Select columns that shuld be excluded when generating the expectation suite. It should be noted that excluded columns will not appear in tables generated by the \\\"Run Expectations\\\" custom step.\\n\\nThe results of this custom step are:\\n* Output files are saved in the directory specified in the folder selector.\\n* A table summarizing the generated expectations and their relevant columns.\\n\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"section1\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Pre-requisites\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"text2\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* Built and tested on SAS Viya Stable Release 2023.04.\\n* Python's great_expectatons library version v0.16.8 or after.\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"section3\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Changelog\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"text4\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* Version 1.0 (8SEP2023)\\n   - Initial version\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"inTable\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"location\": \"\",\n\t\t\"out_expectations\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"suiteName\": \"\",\n\t\t\"excludeCol\": []\n\t}\n}","flowMetadata":{"inputPorts":[{"name":"inTable","displayName":"inTable","description":"","minEntries":1,"maxEntries":1,"type":"table"}],"outputPorts":[{"name":"out_expectations","displayName":"out_expectations","description":"","minEntries":1,"maxEntries":1,"columnDelta":null,"type":"table"}]}}